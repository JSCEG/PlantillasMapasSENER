<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test An√°lisis por Cuartiles - SENER</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c5530;
            text-align: center;
            margin-bottom: 30px;
        }
        .controls {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .btn {
            background-color: #2c5530;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #1e3a21;
        }
        .btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            margin: 5px;
        }
        .results {
            margin-top: 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #2c5530;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9em;
            color: #666;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #2c5530;
            color: white;
            font-weight: bold;
        }
        .cuartil-1 { background-color: #d4edda; }
        .cuartil-2 { background-color: #fff3cd; }
        .cuartil-3 { background-color: #ffeaa7; }
        .cuartil-4 { background-color: #f8d7da; }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .info {
            background-color: #e8f4fd;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .municipios-table {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .export-buttons {
            text-align: center;
            margin: 20px 0;
        }
        .progress {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }
        .progress-bar {
            height: 100%;
            background-color: #28a745;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Test An√°lisis por Cuartiles - SENER</h1>
        
        <div class="info">
            <h3>‚ÑπÔ∏è Informaci√≥n:</h3>
            <p>Esta herramienta permite probar el an√°lisis por cuartiles de los √≠ndices municipales. 
               Primero carga el archivo brillantes.js y luego selecciona el √≠ndice que deseas analizar.</p>
        </div>

        <div class="controls">
            <h3>üéõÔ∏è Controles:</h3>
            <div>
                <button class="btn" id="loadBrillantes">üìÇ Cargar brillantes.js</button>
                <select id="indiceSelect" disabled>
                    <option value="">Selecciona un √≠ndice...</option>
                </select>
                <button class="btn" id="analizarBtn" disabled>üîç Analizar</button>
                <button class="btn" id="analizarTodos" disabled>üìä Analizar Todos</button>
            </div>
        </div>

        <div class="progress" id="progressBar">
            <div class="progress-bar" id="progressBarFill"></div>
        </div>

        <div id="status"></div>
        <div id="results" class="results"></div>
    </div>

    <!-- Scripts -->
    <script src="analisis_cuartiles.js"></script>
    <script>
        let brillantesData = null;
        let currentAnalysis = null;

        // Referencias a elementos DOM
        const loadBtn = document.getElementById('loadBrillantes');
        const indiceSelect = document.getElementById('indiceSelect');
        const analizarBtn = document.getElementById('analizarBtn');
        const analizarTodosBtn = document.getElementById('analizarTodos');
        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');
        const progressBar = document.getElementById('progressBar');
        const progressBarFill = document.getElementById('progressBarFill');

        // Funciones de utilidad
        function showStatus(message, type = 'info') {
            const className = type === 'error' ? 'error' : 
                             type === 'success' ? 'success' : 'info';
            statusDiv.innerHTML = `<div class="${className}">${message}</div>`;
        }

        function showProgress(show = true) {
            progressBar.style.display = show ? 'block' : 'none';
        }

        function updateProgress(percent) {
            progressBarFill.style.width = percent + '%';
        }

        // Cargar brillantes.js
        loadBtn.addEventListener('click', async () => {
            try {
                showStatus('üìÇ Cargando brillantes.js...', 'info');
                showProgress(true);
                updateProgress(20);

                const response = await fetch('indicadores/brillantes.js');
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                updateProgress(50);
                const brillantesText = await response.text();
                
                // Extraer el objeto JavaScript
                const jsonStart = brillantesText.indexOf('{');
                const jsonEnd = brillantesText.lastIndexOf('}') + 1;
                
                if (jsonStart === -1 || jsonEnd === -1) {
                    throw new Error('No se pudo extraer el objeto JSON del archivo brillantes.js');
                }

                updateProgress(80);
                const jsonString = brillantesText.substring(jsonStart, jsonEnd);
                brillantesData = JSON.parse(jsonString);

                updateProgress(100);
                showStatus(`‚úÖ brillantes.js cargado exitosamente. ${brillantesData.features.length} municipios encontrados.`, 'success');
                
                // Habilitar controles
                populateIndiceSelect();
                indiceSelect.disabled = false;
                analizarTodosBtn.disabled = false;

                setTimeout(() => showProgress(false), 1000);

            } catch (error) {
                console.error('Error cargando brillantes.js:', error);
                showStatus(`‚ùå Error cargando brillantes.js: ${error.message}`, 'error');
                showProgress(false);
            }
        });

        // Poblar select de √≠ndices
        function populateIndiceSelect() {
            indiceSelect.innerHTML = '<option value="">Selecciona un √≠ndice...</option>';
            
            Object.keys(window.AnalisisCuartiles.indicesDisponibles).forEach(indice => {
                const nombre = window.AnalisisCuartiles.indicesDisponibles[indice];
                const option = document.createElement('option');
                option.value = indice;
                option.textContent = nombre;
                indiceSelect.appendChild(option);
            });
        }

        // Habilitar bot√≥n analizar cuando se selecciona √≠ndice
        indiceSelect.addEventListener('change', () => {
            analizarBtn.disabled = !indiceSelect.value;
        });

        // Analizar √≠ndice individual
        analizarBtn.addEventListener('click', () => {
            const indiceSeleccionado = indiceSelect.value;
            if (!indiceSeleccionado || !brillantesData) return;

            try {
                showStatus(`üîç Analizando ${window.AnalisisCuartiles.indicesDisponibles[indiceSeleccionado]}...`, 'info');
                
                const analisis = window.AnalisisCuartiles.analizarIndice(brillantesData, indiceSeleccionado);
                
                if (analisis) {
                    currentAnalysis = { [indiceSeleccionado]: analisis };
                    mostrarResultadosIndividual(analisis);
                    showStatus(`‚úÖ An√°lisis completado para ${analisis.nombre}`, 'success');
                } else {
                    showStatus(`‚ö†Ô∏è No se pudo analizar el √≠ndice ${indiceSeleccionado}`, 'error');
                }

            } catch (error) {
                console.error('Error en an√°lisis:', error);
                showStatus(`‚ùå Error en an√°lisis: ${error.message}`, 'error');
            }
        });

        // Analizar todos los √≠ndices
        analizarTodosBtn.addEventListener('click', async () => {
            if (!brillantesData) return;

            try {
                showStatus('üìä Generando reporte completo...', 'info');
                showProgress(true);
                
                // Simular progreso
                for (let i = 0; i <= 100; i += 10) {
                    updateProgress(i);
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                const reporte = window.AnalisisCuartiles.generarReporteCompleto(brillantesData);
                currentAnalysis = reporte.analisis;
                
                mostrarReporteCompleto(reporte);
                showStatus(`‚úÖ Reporte completo generado. ${reporte.resumen.indicesAnalizados} √≠ndices analizados.`, 'success');
                
                setTimeout(() => showProgress(false), 500);

            } catch (error) {
                console.error('Error generando reporte:', error);
                showStatus(`‚ùå Error generando reporte: ${error.message}`, 'error');
                showProgress(false);
            }
        });

        // Mostrar resultados de an√°lisis individual
        function mostrarResultadosIndividual(analisis) {
            const stats = analisis.estadisticas;
            const conteos = analisis.conteos;

            resultsDiv.innerHTML = `
                <h2>üìà Resultados: ${analisis.nombre}</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${stats.min.toFixed(3)}</div>
                        <div class="stat-label">M√≠nimo</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.q1.toFixed(3)}</div>
                        <div class="stat-label">Q1 (25%)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.mediana.toFixed(3)}</div>
                        <div class="stat-label">Mediana (Q2)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.q3.toFixed(3)}</div>
                        <div class="stat-label">Q3 (75%)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.max.toFixed(3)}</div>
                        <div class="stat-label">M√°ximo</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.media.toFixed(3)}</div>
                        <div class="stat-label">Media</div>
                    </div>
                </div>

                <h3>üìä Distribuci√≥n por Cuartiles:</h3>
                <div class="stats-grid">
                    <div class="stat-card cuartil-1">
                        <div class="stat-number">${conteos.Q1}</div>
                        <div class="stat-label">Q1 - Mejor</div>
                    </div>
                    <div class="stat-card cuartil-2">
                        <div class="stat-number">${conteos.Q2}</div>
                        <div class="stat-label">Q2 - Bueno</div>
                    </div>
                    <div class="stat-card cuartil-3">
                        <div class="stat-number">${conteos.Q3}</div>
                        <div class="stat-label">Q3 - Regular</div>
                    </div>
                    <div class="stat-card cuartil-4">
                        <div class="stat-number">${conteos.Q4}</div>
                        <div class="stat-label">Q4 - Cr√≠tico</div>
                    </div>
                </div>

                <div class="export-buttons">
                    <button class="btn" onclick="exportarDatos('json')">üì• Exportar JSON</button>
                    <button class="btn" onclick="exportarDatos('csv')">üìä Exportar CSV</button>
                    <button class="btn" onclick="exportarDatos('html')">üåê Exportar HTML</button>
                </div>
            `;
        }

        // Mostrar reporte completo
        function mostrarReporteCompleto(reporte) {
            let html = `
                <h2>üìä Reporte Completo de An√°lisis</h2>
                <p><strong>Total de municipios:</strong> ${reporte.resumen.totalMunicipios}</p>
                <p><strong>√çndices analizados:</strong> ${reporte.resumen.indicesAnalizados}</p>
                <p><strong>Fecha:</strong> ${new Date(reporte.resumen.fechaAnalisis).toLocaleString('es-MX')}</p>

                <h3>üìà Resumen por √çndices:</h3>
                <table>
                    <thead>
                        <tr>
                            <th>√çndice</th>
                            <th>Min</th>
                            <th>Q1</th>
                            <th>Mediana</th>
                            <th>Q3</th>
                            <th>Max</th>
                            <th>Media</th>
                            <th>Q1</th>
                            <th>Q2</th>
                            <th>Q3</th>
                            <th>Q4</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            Object.values(reporte.analisis).forEach(analisis => {
                const stats = analisis.estadisticas;
                const conteos = analisis.conteos;
                
                html += `
                    <tr>
                        <td><strong>${analisis.nombre}</strong></td>
                        <td>${stats.min.toFixed(3)}</td>
                        <td>${stats.q1.toFixed(3)}</td>
                        <td>${stats.mediana.toFixed(3)}</td>
                        <td>${stats.q3.toFixed(3)}</td>
                        <td>${stats.max.toFixed(3)}</td>
                        <td>${stats.media.toFixed(3)}</td>
                        <td class="cuartil-1">${conteos.Q1}</td>
                        <td class="cuartil-2">${conteos.Q2}</td>
                        <td class="cuartil-3">${conteos.Q3}</td>
                        <td class="cuartil-4">${conteos.Q4}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>

                <div class="export-buttons">
                    <button class="btn" onclick="exportarReporte('json')">üì• Exportar Reporte JSON</button>
                    <button class="btn" onclick="exportarReporte('csv')">üìä Exportar Reporte CSV</button>
                    <button class="btn" onclick="exportarReporte('html')">üåê Exportar Reporte HTML</button>
                </div>
            `;

            resultsDiv.innerHTML = html;
        }

        // Funciones de exportaci√≥n
        function exportarDatos(formato) {
            if (!currentAnalysis) return;

            try {
                const contenido = window.AnalisisCuartiles.exportarAnalisis({ analisis: currentAnalysis }, formato);
                descargarArchivo(contenido, `analisis_cuartiles.${formato}`, formato);
                showStatus(`‚úÖ Datos exportados en formato ${formato.toUpperCase()}`, 'success');
            } catch (error) {
                showStatus(`‚ùå Error exportando: ${error.message}`, 'error');
            }
        }

        function exportarReporte(formato) {
            if (!currentAnalysis) return;

            try {
                const reporte = {
                    resumen: {
                        totalMunicipios: brillantesData.features.length,
                        indicesAnalizados: Object.keys(currentAnalysis).length,
                        fechaAnalisis: new Date().toISOString()
                    },
                    analisis: currentAnalysis
                };

                const contenido = window.AnalisisCuartiles.exportarAnalisis(reporte, formato);
                descargarArchivo(contenido, `reporte_completo.${formato}`, formato);
                showStatus(`‚úÖ Reporte exportado en formato ${formato.toUpperCase()}`, 'success');
            } catch (error) {
                showStatus(`‚ùå Error exportando reporte: ${error.message}`, 'error');
            }
        }

        function descargarArchivo(contenido, nombreArchivo, formato) {
            const mimeTypes = {
                'json': 'application/json',
                'csv': 'text/csv',
                'html': 'text/html'
            };

            const blob = new Blob([contenido], { type: mimeTypes[formato] || 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nombreArchivo;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>