<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mapa Leaflet – Capa RAN (GeoJSON)</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            /* Paleta del usuario (opcional) */
            --verde-marino: #1F7A62;
            --aqua-claro: #95E5E0;
        }

        html,
        body {
            height: 100%;
            margin: 0
        }

        #mapa {
            height: 100vh;
            width: 100%;
        }

        .leaflet-control-layers-expanded {
            max-height: 240px;
            overflow: auto
        }

        .popup-tabla {
            border-collapse: collapse;
            width: 100%;
            font-size: .9rem
        }

        .popup-tabla th {
            text-align: left;
            padding: .25rem .4rem;
            border-bottom: 1px solid #ddd;
            white-space: nowrap
        }

        .popup-tabla td {
            padding: .25rem .4rem;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>

<body>
    <div id="mapa" aria-label="Mapa principal"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ==========================
        //  Configuración del mapa
        // ==========================
        const urlCapaGeoJSON = 'https://cdn.sassoapps.com/Geovisualizador/geojson/ran.geojson';

        // Centro aproximado de México
        const mapa = L.map('mapa', {
            center: [23.6345, -102.5528],
            zoom: 5,
            preferCanvas: true
        });

        // Capas base
        const baseOSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(mapa);

        const baseCarto = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 20,
            attribution: '&copy; OpenStreetMap, &copy; CARTO'
        });

        // Control de capas
        const controlCapas = L.control.layers(
            { 'OpenStreetMap': baseOSM, 'Carto Light': baseCarto },
            {},
            { collapsed: false }
        ).addTo(mapa);

        // Escala
        L.control.scale({ metric: true, imperial: false }).addTo(mapa);

        // ==========================
        //  Estilo y popups de la capa
        // ==========================
        function estiloCapa(feature) {
            return {
                color: getColor(feature),    // Contorno
                weight: 1,
                fillColor: getFill(feature), // Relleno
                fillOpacity: 0.2
            };
        }

        // Puedes personalizar el color según atributos
        function getColor(feature) { return getProp(feature, 'color') || getProp(feature, 'stroke') || 'var(--verde-marino)'; }
        function getFill(feature) { return getProp(feature, 'fill') || 'var(--aqua-claro)'; }

        function getProp(feature, key) {
            return feature && feature.properties && (feature.properties[key] ?? feature.properties[key?.toUpperCase?.()]);
        }

        function construirPopup(props) {
            if (!props) return '<em>Sin propiedades</em>';
            const filas = Object.keys(props).map(k => {
                const v = props[k];
                return `<tr><th>${k}</th><td>${v}</td></tr>`;
            }).join('');
            return `<div><h4 style="margin:.2rem 0 .4rem 0">Detalle</h4><table class="popup-tabla">${filas}</table></div>`;
        }

        // ==========================
        //  Cargar GeoJSON remoto
        // ==========================
        let capaRAN;

        fetch(urlCapaGeoJSON, { mode: 'cors' })
            .then(r => { if (!r.ok) throw new Error(`Error HTTP ${r.status}`); return r.json(); })
            .then(geojson => {
                capaRAN = L.geoJSON(geojson, {
                    style: estiloCapa,
                    onEachFeature: (feature, layer) => {
                        layer.bindPopup(construirPopup(feature.properties));
                        layer.on('mouseover', () => layer.setStyle({ weight: 2 }));
                        layer.on('mouseout', () => layer.setStyle({ weight: 1 }));
                    }
                }).addTo(mapa);

                controlCapas.addOverlay(capaRAN, 'RAN (GeoJSON)');

                // Enfocar al contenido
                try {
                    const bounds = capaRAN.getBounds();
                    if (bounds.isValid()) mapa.fitBounds(bounds, { padding: [20, 20] });
                } catch { /* sin-op */ }
            })
            .catch(err => {
                console.error(err);
                alert('No se pudo cargar el GeoJSON. Verifica la URL o los encabezados CORS del servidor.');
            });
    </script>
</body>

</html>